# Нагрузочное тестирование утилитой wrk2

Параметры wrk2:

* время тестирования - 30 секунд
* количество открытых соединений - 1
* количество используемых потоков - 1
* количество запросов в секунду - 1000

## PUT-запросы:

```
$ wrk2 -c1 -t1 -d30s -R1000 -L -s 2021-highload-dht/src/main/resources/wrk-scripts/put_entity.lua http://localhost:8080
Running 30s test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.231ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.18ms  439.84us   2.78ms   63.83%
    Req/Sec     1.05k    81.97     1.33k    83.25%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.18ms
 75.000%    1.48ms
 90.000%    1.81ms
 99.000%    2.06ms
 99.900%    2.32ms
 99.990%    2.74ms
 99.999%    2.78ms
100.000%    2.78ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.117     0.000000            1         1.00
       0.567     0.100000         2007         1.11
       0.777     0.200000         4007         1.25
       0.948     0.300000         6005         1.43
       1.066     0.400000         8001         1.67
       1.185     0.500000        10004         2.00
       1.240     0.550000        11012         2.22
       1.295     0.600000        12010         2.50
       1.352     0.650000        13005         2.86
       1.411     0.700000        13999         3.33
       1.477     0.750000        15000         4.00
       1.518     0.775000        15496         4.44
       1.576     0.800000        15996         5.00
       1.629     0.825000        16497         5.71
       1.684     0.850000        16998         6.67
       1.746     0.875000        17497         8.00
       1.777     0.887500        17752         8.89
       1.808     0.900000        18001        10.00
       1.836     0.912500        18245        11.43
       1.871     0.925000        18503        13.33
       1.895     0.937500        18745        16.00
       1.909     0.943750        18872        17.78
       1.927     0.950000        19006        20.00
       1.942     0.956250        19124        22.86
       1.959     0.962500        19248        26.67
       1.979     0.968750        19370        32.00
       1.989     0.971875        19432        35.56
       1.998     0.975000        19499        40.00
       2.008     0.978125        19558        45.71
       2.019     0.981250        19622        53.33
       2.030     0.984375        19683        64.00
       2.036     0.985938        19716        71.11
       2.045     0.987500        19745        80.00
       2.053     0.989062        19779        91.43
       2.061     0.990625        19808       106.67
       2.069     0.992188        19839       128.00
       2.073     0.992969        19859       142.22
       2.079     0.993750        19872       160.00
       2.087     0.994531        19886       182.86
       2.099     0.995313        19903       213.33
       2.107     0.996094        19918       256.00
       2.117     0.996484        19924       284.44
       2.149     0.996875        19933       320.00
       2.169     0.997266        19940       365.71
       2.193     0.997656        19948       426.67
       2.229     0.998047        19955       512.00
       2.267     0.998242        19960       568.89
       2.279     0.998437        19963       640.00
       2.295     0.998633        19967       731.43
       2.315     0.998828        19971       853.33
       2.327     0.999023        19975      1024.00
       2.333     0.999121        19977      1137.78
       2.343     0.999219        19980      1280.00
       2.359     0.999316        19981      1462.86
       2.383     0.999414        19983      1706.67
       2.487     0.999512        19985      2048.00
       2.499     0.999561        19986      2275.56
       2.511     0.999609        19987      2560.00
       2.529     0.999658        19988      2925.71
       2.565     0.999707        19989      3413.33
       2.593     0.999756        19991      4096.00
       2.593     0.999780        19991      4551.11
       2.593     0.999805        19991      5120.00
       2.593     0.999829        19991      5851.43
       2.743     0.999854        19992      6826.67
       2.743     0.999878        19992      8192.00
       2.743     0.999890        19992      9102.22
       2.751     0.999902        19993     10240.00
       2.751     0.999915        19993     11702.86
       2.751     0.999927        19993     13653.33
       2.751     0.999939        19993     16384.00
       2.751     0.999945        19993     18204.44
       2.783     0.999951        19994     20480.00
       2.783     1.000000        19994          inf
#[Mean    =        1.182, StdDeviation   =        0.440]
#[Max     =        2.782, Total count    =        19994]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  29999 requests in 30.00s, 2.12MB read
Requests/sec:    999.97
Transfer/sec:     72.26KB

```

### Максимальное время ответа на запрос для различных доверительных интервалов:

* 75.00% - 1.48ms
* 99.00% - 2.49ms
* 99.99% - 2.74ms
* 100.00% - 2.78ms

## GET-запросы:

```
$ wrk2 -c1 -t1 -d30s -R1000 -L -s 2021-highload-dht/src/main/resources/wrk-scripts/get_entity.lua http://localhost:8080
Running 30s test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.185ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.16ms  527.66us  13.09ms   72.28%
    Req/Sec     1.05k   100.06     2.33k    81.79%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.14ms
 75.000%    1.44ms
 90.000%    1.77ms
 99.000%    2.04ms
 99.900%    5.93ms
 99.990%   12.26ms
 99.999%   13.10ms
100.000%   13.10ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.065     0.000000            1         1.00
       0.535     0.100000         2005         1.11
       0.725     0.200000         4004         1.25
       0.900     0.300000         6015         1.43
       1.023     0.400000         8017         1.67
       1.139     0.500000        10010         2.00
       1.198     0.550000        11007         2.22
       1.255     0.600000        11999         2.50
       1.317     0.650000        13006         2.86
       1.376     0.700000        14001         3.33
       1.438     0.750000        15013         4.00
       1.476     0.775000        15507         4.44
       1.518     0.800000        15997         5.00
       1.571     0.825000        16506         5.71
       1.643     0.850000        17000         6.67
       1.710     0.875000        17502         8.00
       1.740     0.887500        17752         8.89
       1.769     0.900000        18005        10.00
       1.808     0.912500        18246        11.43
       1.851     0.925000        18497        13.33
       1.889     0.937500        18749        16.00
       1.908     0.943750        18880        17.78
       1.926     0.950000        18996        20.00
       1.941     0.956250        19121        22.86
       1.958     0.962500        19253        26.67
       1.969     0.968750        19374        32.00
       1.975     0.971875        19442        35.56
       1.980     0.975000        19497        40.00
       1.990     0.978125        19561        45.71
       1.999     0.981250        19621        53.33
       2.015     0.984375        19689        64.00
       2.022     0.985938        19720        71.11
       2.027     0.987500        19748        80.00
       2.035     0.989062        19778        91.43
       2.042     0.990625        19809       106.67
       2.049     0.992188        19841       128.00
       2.055     0.992969        19856       142.22
       2.065     0.993750        19874       160.00
       2.075     0.994531        19887       182.86
       2.111     0.995313        19902       213.33
       2.263     0.996094        19917       256.00
       2.485     0.996484        19925       284.44
       2.829     0.996875        19933       320.00
       3.247     0.997266        19941       365.71
       3.639     0.997656        19949       426.67
       4.303     0.998047        19956       512.00
       4.343     0.998242        19960       568.89
       4.603     0.998437        19964       640.00
       5.135     0.998633        19968       731.43
       5.295     0.998828        19972       853.33
       6.075     0.999023        19976      1024.00
       6.499     0.999121        19978      1137.78
       7.007     0.999219        19981      1280.00
       7.167     0.999316        19982      1462.86
       7.899     0.999414        19984      1706.67
       8.791     0.999512        19986      2048.00
       9.655     0.999561        19987      2275.56
       9.679     0.999609        19988      2560.00
      10.519     0.999658        19990      2925.71
      10.519     0.999707        19990      3413.33
      11.383     0.999756        19991      4096.00
      11.383     0.999780        19991      4551.11
      11.695     0.999805        19992      5120.00
      11.695     0.999829        19992      5851.43
      12.255     0.999854        19993      6826.67
      12.255     0.999878        19993      8192.00
      12.255     0.999890        19993      9102.22
      12.319     0.999902        19994     10240.00
      12.319     0.999915        19994     11702.86
      12.319     0.999927        19994     13653.33
      12.319     0.999939        19994     16384.00
      12.319     0.999945        19994     18204.44
      13.095     0.999951        19995     20480.00
      13.095     1.000000        19995          inf
#[Mean    =        1.156, StdDeviation   =        0.528]
#[Max     =       13.088, Total count    =        19995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  30000 requests in 30.00s, 1.91MB read
Requests/sec:    999.99
Transfer/sec:     65.07KB

```

### Максимальное время ответа на запрос для различных доверительных интервалов:

* 75.00% - 1.74ms
* 99.00% - 2.04ms
* 99.99% - 12.26ms
* 100.00% - 13.10ms

# Профилирование с помощью async-profiler

## PUT-запросы:

### Профилирование CPU

[put_cpu.html](profiling/put_cpu.html)

####Наблюдения

* Глобально большую часть времени занимают системные вызовы записи `46.61%` и чтения `6.23%` из сокета (уровень TCP)
* В написанном коде большую часть времени занимает метод `BasicService.entity(..)`, использующий `6.5%` процессорных
  ресурсов, причем `6.23%` использует в частности функция `LSMDAO.upsert(..)`

### Профилирование RAM

[put_mem.html](profiling/put_mem.html)

####Наблюдения
* Функция добавления записи в базу данных `DaoWrapper.putEntity(..)` использует `28.13%` ресурсов оперативной памяти. 
Наиболее ресурсозатратной функцией на более глубоком уровне стека является функция записи в базу `LsmDAO.upsert(..)`
, на которую приходится 7.29% выделений оперативной памяти
* Функция записи ответа на запрос `HttpSession.writeResponse(..)` использует `11.46%` ресурсов оперативной памяти

## GET-запросы:

### Профилирование CPU

[get_cpu.html](profiling/get_cpu.html)

####Наблюдения
* Глобально большую часть процессорных ресурсов использует системный вызов записи в сокет `26.53%` (уровень TCP)
* Непонятно что за манипуляции производятся с библиотекой `libjvm.so`, но стоит заметить, что она использует `26.30%`
  процессорных ресурсов
* В написанном коде большую часть времени занимает метод `BasicService.entity(..)`, использующий `6.58%` процессорных
  ресурсов, причем `4.54%` использует в частности функция `LSMDAO.range(..)`

### Профилирование RAM

[get_mem.html](profiling/get_mem.html)

####Наблюдения
* Чтение из базы данных `LsmDAO.range(..)` использует `22.86%` ресурсов оперативной памяти
* Запись ответа на запрос `HttpSession.writeResponse(..)` использует `17.4%` ресурсов оперативной памяти
